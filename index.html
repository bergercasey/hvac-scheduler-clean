
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HVAC Weekly Schedule</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #fff; }
    h1 { text-align: center; margin-bottom: 10px; }
    .button-row { text-align: center; margin-bottom: 15px; }
    .button-row button { margin: 0 5px; padding: 6px 10px; font-size: 14px; }

    .weekday-header {
      display: grid;
      grid-template-columns: 150px repeat(5, 1fr);
      text-align: center;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .weekday-header div { padding: 5px 0; }

    .grid {
      display: grid;
      grid-template-columns: 150px repeat(5, 1fr);
      row-gap: 6px;
      column-gap: 4px;
    }
    .crew-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-weight: bold;
    }
    .crew-label input { width: 90%; margin: 2px 0; }

    .cell { border: 1px solid #ccc; padding: 2px; position: relative; }
    .job-input, .helper-input {
      width: 100%; border: none; padding: 2px; font-size: 14px; box-sizing: border-box;
    }
    .job-input { resize: none; } /* textarea */
    .helper-input { color: blue; }

    .pto-box, .helper-pto-box {
      position: absolute; width: 14px; height: 14px; cursor: pointer;
      appearance: auto; -webkit-appearance: auto;
    }
    .pto-box { top: 2px; right: 2px; accent-color: red; }
    .helper-pto-box { bottom: 2px; right: 2px; accent-color: blue; }

    .highlight-red { background-color: #ffd6d6; }

    /* Calendar popup */
    .calendar-popup {
      position: absolute; top: 60px; left: 20px;
      background: #fff; border: 1px solid #ccc; padding: 10px;
      z-index: 999; font-size: 14px; width: 260px;
    }
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center;
      font-weight: bold; margin-bottom: 5px;
    }
    .calendar-nav { cursor: pointer; padding: 0 10px; user-select: none; }
    .calendar-popup table { width: 100%; border-collapse: collapse; }
    .calendar-popup th, .calendar-popup td {
      width: 14.2%; text-align: center; padding: 4px; cursor: pointer;
    }
    .calendar-popup th { font-weight: bold; }
    .calendar-popup td:hover { background: #eee; }
  </style>
</head>
<body>
  <h1>HVAC Weekly Schedule</h1>
  <div class="button-row">
    <button id="calendarBtn">ðŸ“…</button>
    <button id="prevWeekBtn">Previous Week</button>
    <button id="todayBtn">Today</button>
    <button id="nextWeekBtn">Next Week</button>
    <button id="resetBtn">Reset Week</button>
    <button id="printBtn">Print</button>
  </div>

  <div class="weekday-header" id="weekdayHeader"></div>
  <div class="grid" id="scheduleGrid"></div>
  <div id="calendarContainer" class="calendar-popup" style="display:none;"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        d.setDate(diff);
        d.setHours(0,0,0,0);
        return d;
      }

      function formatDate(d) {
        return `${d.getMonth()+1}/${d.getDate()}`;
      }

      function renderHeader(startDate) {
        const header = document.getElementById("weekdayHeader");
        header.innerHTML = "<div>Crew</div>";
        for (let i = 0; i < 5; i++) {
          const d = new Date(startDate);
          d.setDate(startDate.getDate() + i);
          const dayName = d.toLocaleDateString("en-US", { weekday: "short" });
          header.innerHTML += `<div>${dayName} ${formatDate(d)}</div>`;
        }
      }

      function createGrid() {
        const grid = document.getElementById("scheduleGrid");
        grid.innerHTML = "";
        for (let row = 0; row < 12; row++) {
          const crewCell = document.createElement("div");
          crewCell.className = "crew-label";
          crewCell.innerHTML = `
            <input type="text" class="lead-input" placeholder="Lead" />
            <input type="text" class="apprentice-input" placeholder="Apprentice" />
          `;
          grid.appendChild(crewCell);

          for (let col = 0; col < 5; col++) {
            const cell = document.createElement("div");
            cell.className = "cell";

            const job = document.createElement("textarea");
            job.className = "job-input";
            job.rows = 2;
            job.placeholder = col === 0 ? "Job" : "";
            cell.appendChild(job);

            const helper = document.createElement("input");
            helper.className = "helper-input";
            helper.placeholder = col === 0 ? "Helper" : "";
            cell.appendChild(helper);

            const pto = document.createElement("input");
            pto.type = "checkbox";
            pto.className = "pto-box";
            pto.addEventListener("change", () => {
              if (pto.checked) cell.classList.add("highlight-red");
              else cell.classList.remove("highlight-red");
            });
            cell.appendChild(pto);

            const helperPto = document.createElement("input");
            helperPto.type = "checkbox";
            helperPto.className = "helper-pto-box";
            helperPto.addEventListener("change", () => {}); // blue check only
            cell.appendChild(helperPto);

            grid.appendChild(cell);
          }
        }
      }

      // Calendar state
      let calendarMonthOffset = 0;

      function renderCalendar(referenceDate) {
        const cal = document.getElementById("calendarContainer");
        const ref = new Date(referenceDate);
        ref.setMonth(ref.getMonth() + calendarMonthOffset);
        const year = ref.getFullYear();
        const month = ref.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        const monthName = ref.toLocaleString("default", { month: "long" });
        let html = `<div class="calendar-header">
                      <span class="calendar-nav" id="calPrev">â€¹</span>
                      <span>${monthName} ${year}</span>
                      <span class="calendar-nav" id="calNext">â€º</span>
                    </div>`;

        html += "<table><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr><tr>";
        for (let i = 0; i < firstDay.getDay(); i++) html += "<td></td>";
        for (let d = 1; d <= lastDay.getDate(); d++) {
          const thisDate = new Date(year, month, d);
          html += `<td data-ymd="${year}-${month+1}-${d}">${d}</td>`;
          if (thisDate.getDay() === 6) html += "</tr><tr>";
        }
        html += "</tr></table>";
        cal.innerHTML = html;

        // Wire nav + day clicks
        document.getElementById("calPrev").onclick = () => { calendarMonthOffset -= 1; renderCalendar(referenceDate); };
        document.getElementById("calNext").onclick = () => { calendarMonthOffset += 1; renderCalendar(referenceDate); };
        cal.querySelectorAll("td[data-ymd]").forEach(td => {
          td.onclick = () => jumpToDate(td.getAttribute("data-ymd"));
        });
      }

      window.jumpToDate = (ymd) => {
        const [y, m, d] = ymd.split("-").map(Number);
        const picked = new Date(y, m - 1, d);
        currentStartDate = getStartOfWeek(picked);
        renderHeader(currentStartDate);
        document.getElementById("calendarContainer").style.display = "none";
        calendarMonthOffset = 0; // reset for next open
      };

      let currentStartDate = getStartOfWeek(new Date());
      renderHeader(currentStartDate);
      createGrid();

      // Buttons
      document.getElementById("prevWeekBtn").onclick = () => {
        currentStartDate.setDate(currentStartDate.getDate() - 7);
        renderHeader(currentStartDate);
      };
      document.getElementById("nextWeekBtn").onclick = () => {
        currentStartDate.setDate(currentStartDate.getDate() + 7);
        renderHeader(currentStartDate);
      };
      document.getElementById("todayBtn").onclick = () => {
        currentStartDate = getStartOfWeek(new Date());
        renderHeader(currentStartDate);
      };
      document.getElementById("resetBtn").onclick = () => {
        // Clear only current visible week's fields
        document.querySelectorAll("#scheduleGrid input, #scheduleGrid textarea").forEach(el => {
          if (el.type === "checkbox") el.checked = false;
          else el.value = "";
        });
        document.querySelectorAll("#scheduleGrid .cell").forEach(c => c.classList.remove("highlight-red"));
        renderHeader(currentStartDate);
      };
      document.getElementById("printBtn").onclick = () => window.print();

      const calendarBtn = document.getElementById("calendarBtn");
      const calendarContainer = document.getElementById("calendarContainer");
      calendarBtn.onclick = () => {
        const show = calendarContainer.style.display === "none";
        calendarContainer.style.display = show ? "block" : "none";
        if (show) renderCalendar(currentStartDate);
      };
    });
  </script>

<div id="bottomSection" style="display: flex; margin-top: 20px; max-width: 1000px; margin-left: auto; margin-right: auto; gap: 10px;">
  <!-- Floaters -->
  <div id="floatersSection" style="flex: 1; min-width: 200px;">
    <h3 style="text-align: center; margin: 4px 0;">Floaters</h3>
    <div style="display: flex; flex-direction: column; gap: 4px;"><div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 1" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 2" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 3" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 4" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 5" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 6" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 7" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 8" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 9" style="flex: 1; padding: 4px; font-size: 14px;"></div>
<div style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="floater-check" style="flex-shrink:0;"><input type="text" class="floater-name" placeholder="Floater 10" style="flex: 1; padding: 4px; font-size: 14px;"></div></div>
  </div>
  <!-- Need to be done jobs -->
  <div id="todoSection" style="flex: 3;">
    <h3 style="text-align: center; margin: 4px 0;">Need to be done jobs</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
      <input type="text" class="todo-job" placeholder="Job 1" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 2" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 3" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 4" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 5" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 6" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 7" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 8" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 9" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 10" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 11" style="padding: 4px; font-size: 14px;">
<input type="text" class="todo-job" placeholder="Job 12" style="padding: 4px; font-size: 14px;">
    </div>
  </div>
</div>


<style>
  .floater-name.assigned { background-color: #ffcccc; }
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.floater-check').forEach((check, idx) => {
    check.addEventListener('change', (e) => {
      const input = check.parentElement.querySelector('.floater-name');
      if (check.checked) {
        input.classList.add('assigned');
      } else {
        input.classList.remove('assigned');
      }
    });
  });

  // Helper PTO checkboxes
  document.querySelectorAll('.helper-pto-box').forEach((check, idx) => {
    check.addEventListener('change', () => {
      addLog(`Helper PTO ${idx+1} set to ${check.checked}`);
    });
  });

});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- utils ----------
  const DAYS=['Mon','Tue','Wed','Thu','Fri'], pad2=n=>String(n).padStart(2,'0');
  const log=(m,o)=> (window.addLog?addLog(m+(o?(' '+JSON.stringify(o)):''))
                                  :console.log('[LOG]',m,o||''));
  const Q = s => Array.from(document.querySelectorAll(s));

  // Weekly grid selectors (cells that belong to Monâ€“Fri grid)
  const jobSel    = '.job-input, input.job, input[data-role="job"], input[aria-label="Job"], input[placeholder="Job"]:not(.todo-job)';
  const helperSel = '.helper-input, input.helper, input[data-role="helper"], input[aria-label="Helper"], input[placeholder="Helper"]';
  const ptoSel    = '.pto-box';
  const helperPto = '.helper-pto-box';

  // Persistent lists (never cleared by Reset)
  const leadSel    = '.lead-input';
  const apprSel    = '.apprentice-input';
  const floaterSel = '.floater-name';
  const todoSel    = '.todo-job';

  // Tag only true weekly grid elements so we never touch persistent ones
  function tagWeekElements(){
    const isPersistent = el => el.matches(leadSel) || el.matches(apprSel) || el.matches(floaterSel) || el.matches(todoSel);
    [...Q(jobSel), ...Q(helperSel), ...Q(ptoSel), ...Q(helperPto)].forEach(el=>{
      if (!isPersistent(el)) el.setAttribute('data-week-cell','1');
    });
  }

  // Week key helpers
  function mondayOf(d){ const x=new Date(d); x.setHours(0,0,0,0); const wd=x.getDay(); const diff=(wd===0?-6:1-wd); x.setDate(x.getDate()+diff); return x; }
  function isoWeekKeyFromDate(d){
    const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    x.setUTCDate(x.getUTCDate()+4-(x.getUTCDay()||7));
    const y0=new Date(Date.UTC(x.getUTCFullYear(),0,1));
    const wk=Math.ceil((((x-y0)/86400000)+1)/7);
    return `${x.getUTCFullYear()}-W${String(wk).padStart(2,'0')}`;
  }

  // Current displayed week (persist which Monday you were on)
  const state = {
    monday: (() => { const s=localStorage.getItem('displayedMonday'); return s? new Date(s) : mondayOf(new Date()); })(),
    setMonday(d){ this.monday=mondayOf(d); localStorage.setItem('displayedMonday', this.monday.toISOString()); loadWeekFor(this.monday).catch(e=>log('load err',{msg:String(e)})); },
    weekKey(){ return isoWeekKeyFromDate(this.monday); }
  };

  // Collect weekly grid only
  function collectWeekFlat(){
    const out={}, jobs=Q('[data-week-cell="1"]').filter(el=>el.matches(jobSel)),
                   helpers=Q('[data-week-cell="1"]').filter(el=>el.matches(helperSel)),
                   leadP=Q('[data-week-cell="1"]').filter(el=>el.matches(ptoSel)),
                   helpP=Q('[data-week-cell="1"]').filter(el=>el.matches(helperPto));
    const max=Math.max(jobs.length, helpers.length, leadP.length, helpP.length);
    for(let i=0;i<max;i++){
      const row=Math.floor(i/5)+1, day=DAYS[i%5], r=pad2(row), base=`${day}:${r}`;
      if(jobs[i]   && jobs[i].value)    out[`${base}:job`] = jobs[i].value;
      if(helpers[i]&& helpers[i].value) out[`${base}:helper`] = helpers[i].value;
      if(leadP[i]  && leadP[i].checked) out[`${base}:pto`] = true;
      if(helpP[i]  && helpP[i].checked) out[`${base}:helperPto`] = true;
    }
    return out;
  }

  // Clear ONLY the weekly grid (tagged elements), leave persistent alone
  function clearWeekGrid(){
    Q('[data-week-cell="1"]').forEach(el=>{
      if (el.matches(jobSel) || el.matches(helperSel)) el.value='';
      if (el.matches(ptoSel) || el.matches(helperPto)) {
        const was=el.checked; el.checked=false;
        if (was) el.dispatchEvent(new Event('change',{bubbles:true})); // restore red shading/removal
      }
    });
  }

  // Apply week data safely (start clean to avoid leftovers)
  let applying=false;
  function applyWeekData(data){
    applying=true;
    clearWeekGrid();
    const jobs=Q('[data-week-cell="1"]').filter(el=>el.matches(jobSel)),
          helpers=Q('[data-week-cell="1"]').filter(el=>el.matches(helperSel)),
          leadP=Q('[data-week-cell="1"]').filter(el=>el.matches(ptoSel)),
          helpP=Q('[data-week-cell="1"]').filter(el=>el.matches(helperPto));
    Object.entries(data||{}).forEach(([k,v])=>{
      const m=k.match(/^(Mon|Tue|Wed|Thu|Fri):(\d{2}):(job|helper|pto|helperPto)$/);
      if(!m) return;
      const dayIdx=DAYS.indexOf(m[1]), row=parseInt(m[2],10)-1, idx=row*5+dayIdx;
      if(m[3]==='job'      && jobs[idx])   jobs[idx].value   = String(v);
      if(m[3]==='helper'   && helpers[idx])helpers[idx].value= String(v);
      if(m[3]==='pto'      && leadP[idx]) { leadP[idx].checked = !!v;  leadP[idx].dispatchEvent(new Event('change',{bubbles:true})); }
      if(m[3]==='helperPto'&& helpP[idx]) { helpP[idx].checked = !!v;  helpP[idx].dispatchEvent(new Event('change',{bubbles:true})); }
    });
    applying=false;
  }

  // Persistent collect/apply (unchanged by Reset)
  function collectPersistent(){
    const out={};
    Q(leadSel).forEach((el,i)=> el.value && (out[`Lead:${pad2(i+1)}`]=el.value));
    Q(apprSel).forEach((el,i)=> el.value && (out[`Apprentice:${pad2(i+1)}`]=el.value));
    Q(floaterSel).forEach((el,i)=> el.value && (out[`Floater:${pad2(i+1)}`]=el.value));
    Q(todoSel).forEach((el,i)=> el.value && (out[`Todo:${pad2(i+1)}`]=el.value));
    return out;
  }
  function applyPersistent(data){
    const put=(sel,prefix)=>{
      const list=Q(sel);
      Object.entries(data||{}).forEach(([k,v])=>{
        const m=k.match(new RegExp(`^${prefix}:(\\d{2})$`)); if(!m) return;
        const idx=parseInt(m[1],10)-1; if(list[idx]) list[idx].value=String(v);
      });
    };
    put(leadSel,'Lead'); put(apprSel,'Apprentice'); put(floaterSel,'Floater'); put(todoSel,'Todo');
  }

  // --- API (direct to Netlify functions) ---
  async function saveWeekFor(d){
    const res = await fetch('/.netlify/functions/save-week', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ weekKey: isoWeekKeyFromDate(d), data: collectWeekFlat() })
    });
    const txt=await res.text().catch(()=> ''); log('save-week',{status:res.status, ok:res.ok, body:txt.slice(0,160)});
  }
  async function loadWeekFor(d){
    const key=isoWeekKeyFromDate(d);
    const res = await fetch(`/.netlify/functions/load-week?weekKey=${encodeURIComponent(key)}`);
    const json = await res.json().catch(()=> ({}));
    if(json && json.ok) applyWeekData(json.data||{});
    log('load-week',{status:res.status, ok:res.ok, key});
  }
  async function wipeWeek(d){
    const res = await fetch('/.netlify/functions/save-week', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ weekKey: isoWeekKeyFromDate(d), wipe:true })
    });
    const txt=await res.text().catch(()=> ''); log('wipe-week',{status:res.status, ok:res.ok, body:txt.slice(0,160)});
  }
  async function savePersistent(){
    const res = await fetch('/.netlify/functions/save-persistent', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ data: collectPersistent() })
    });
    const txt=await res.text().catch(()=> ''); log('save-persistent',{status:res.status, ok:res.ok, body:txt.slice(0,160)});
  }
  async function loadPersistent(){
    const res = await fetch('/.netlify/functions/load-persistent');
    const json = await res.json().catch(()=> ({}));
    if(json && json.ok) applyPersistent(json.data||{});
    log('load-persistent',{status:res.status, ok:res.ok});
  }

  // --- Autosave (separate)
  let tWeek=null, tPersist=null;
  const deb=(fn,slot)=>{ clearTimeout(slot.id); slot.id=setTimeout(fn, 800); };

  document.addEventListener('input',(e)=>{
    if(applying) return;
    if (e.target.matches('[data-week-cell="1"]') && (e.target.matches(jobSel) || e.target.matches(helperSel)))
      deb(()=>saveWeekFor(state.monday), tWeek={id:tWeek});
    if (e.target.matches(leadSel)||e.target.matches(apprSel)||e.target.matches(floaterSel)||e.target.matches(todoSel))
      deb(savePersistent, tPersist={id:tPersist});
  }, {passive:true});

  document.addEventListener('change',(e)=>{
    if(applying) return;
    if (e.target.matches('[data-week-cell="1"]') && (e.target.matches(ptoSel) || e.target.matches(helperPto)))
      deb(()=>saveWeekFor(state.monday), tWeek={id:tWeek});
  }, {passive:true});

  // --- Reset current week ONLY (and keep persistent values)
  async function resetCurrentWeek(){
    clearWeekGrid();                // visually clear current grid
    await wipeWeek(state.monday);   // write empty week for this specific weekKey
    await loadPersistent();         // re-apply Leads/Apprentices immediately (avoid flicker)
  }
  document.getElementById('resetBtn')?.addEventListener('click',(e)=>{
    e.preventDefault(); resetCurrentWeek().catch(err=>log('reset error',{msg:String(err)}));
  });

  // Week navigation (prev/next/today) â€” only affects displayed week
  document.getElementById('prevWeekBtn')?.addEventListener('click',(e)=>{ e.preventDefault(); const d=new Date(state.monday); d.setDate(d.getDate()-7); state.setMonday(d); });
  document.getElementById('nextWeekBtn')?.addEventListener('click',(e)=>{ e.preventDefault(); const d=new Date(state.monday); d.setDate(d.getDate()+7); state.setMonday(d); });
  document.getElementById('todayBtn')   ?.addEventListener('click',(e)=>{ e.preventDefault(); state.setMonday(new Date()); });

  // ---- Init: tag week cells, then load chosen week + persistent
  const wait = setInterval(()=> {
    if (Q(jobSel).length || Q(helperSel).length || Q(ptoSel).length) {
      clearInterval(wait);
      tagWeekElements();
      loadWeekFor(state.monday).then(loadPersistent);
    }
  }, 150);

  // Expose manual helpers if you keep debug buttons
  window.saveNow = ()=>Promise.all([saveWeekFor(state.monday), savePersistent()]);
  window.loadNow = ()=>Promise.all([loadWeekFor(state.monday), loadPersistent()]);
});
</script>

</body>
</html>
