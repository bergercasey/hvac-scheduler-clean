<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HVAC Weekly Schedule</title>
<style>
  :root{
    --grid-w: 1200px;            /* keeps bottom sections aligned with grid width */
    --col-left: 180px;           /* crew column */
    --col-day: 190px;            /* each day column */
    --gap: 8px;
    --radius: 8px;
    --stroke: #d0d0d0;
    --shade: rgba(255,0,0,0.08); /* light red shading for LEAD PTO */
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fff; color:#222; }

  /* Header + buttons */
  header { padding:16px 10px 8px; }
  h1 { text-align:center; margin:0 0 10px; font-size:20px; }
  .toolbar {
    display:flex; align-items:center; justify-content:center; gap:10px;
  }
  .btn {
    padding:6px 10px; border:1px solid #c9c9c9; border-radius:6px; background:#f7f7f7;
    font-size:14px; line-height:1; cursor:pointer;
  }
  .btn:active { transform: translateY(1px); }
  .cal-btn { display:inline-flex; align-items:center; gap:6px; }

  /* Grid shell */
  .wrap { display:flex; justify-content:center; }
  .grid {
    width: min(100%, var(--grid-w));
    margin: 8px auto 16px;
    display:grid;
    grid-template-columns: var(--col-left) repeat(5, var(--col-day));
    gap: var(--gap);
    align-items: start;
  }

  /* Header row */
  .th {
    position:sticky; top:0; z-index:2;
    background:#fff; border:1px solid var(--stroke); border-radius:6px;
    padding:8px; text-align:center; font-weight:600; font-size:13px;
  }
  .th.small { font-weight:700; }

  /* Crew column cells */
  .crewcell {
    border:1px solid var(--stroke); border-radius:6px; padding:8px;
    display:flex; flex-direction:column; gap:6px;
    background:#fff;
  }
  .crewcell input[type="text"] {
    width:100%; padding:6px 8px; border:1px solid var(--stroke); border-radius:6px;
    font-size:14px;
  }

  /* Day cells */
  .cell {
    border:1px solid var(--stroke); border-radius:6px; background:#fff;
    padding:8px; position:relative; overflow:clip; /* prevents bubble overrun */
  }

  /* Bubble containing job/helper + PTO checks (kept inside cell) */
  .bubble {
    position:relative; border:1px solid var(--stroke); border-radius: var(--radius);
    padding:8px 28px 8px 8px; /* room on right for PTO checkboxes */
    background:#fff; display:flex; flex-direction:column; gap:6px;
  }

  /* When LEAD PTO is checked, tint the whole bubble */
  .bubble.lead-out { background: var(--shade); }

  /* Inputs */
  textarea.job {
    width:100%; min-height:2.6em; max-height:4.8em; /* shows ~2 lines; can grow a bit */
    resize:none; border:1px solid var(--stroke); border-radius:6px; padding:6px 8px;
    font-size:15px; line-height:1.2; overflow:auto;
  }
  input.helper {
    width:100%; border:1px solid var(--stroke); border-radius:6px; padding:6px 8px;
    font-size:14px; color:#1666ff; /* Helper text blue */
  }
  input.helper::placeholder { color:#8bb0ff; }

  /* Tiny PTO checkboxes tucked INSIDE the bubble (upper-right corner stack) */
  .ptos {
    position:absolute; right:6px; top:6px; display:flex; flex-direction:column; gap:6px;
    align-items:flex-end;
  }
  .ptos label {
    display:flex; align-items:center; gap:4px; font-size:11px; color:#666;
    background:#fff; padding:2px 4px; border:1px solid var(--stroke); border-radius:5px;
  }
  /* Make the native checks small */
  .ptos input[type="checkbox"] {
    width:14px; height:14px; accent-color:#999; /* default for LEAD */
    margin:0;
  }
  /* Helper PTO should show a red check but NOT trigger shading */
  .ptos input.helper-pto { accent-color:#d22; } /* red check color */

  /* Focus outlines (iPad friendly) */
  textarea:focus, input[type="text"]:focus { outline: 2px solid #a7c7ff; }

  /* Debug log */
  .log {
    width:min(100%, var(--grid-w));
    margin:0 auto 24px; border-top:1px solid #eee; padding:10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12px; max-height:160px; overflow:auto; background:#fafafa;
  }
  .row { display:contents; } /* semantic wrapper for each crew row */

  /* Bottom sections (aligned to grid width) */
  .bottom {
    width:min(100%, var(--grid-w));
    margin: 4px auto 24px;
    display:grid; grid-template-columns: 1fr 3fr; gap: var(--gap);
  }
  .floater, .todo {
    border:1px solid var(--stroke); border-radius:6px; padding:8px; background:#fff;
  }
  .floater h3, .todo h3 { margin:0 0 6px; font-size:14px; text-align:left; }
  .floater .item { display:flex; align-items:center; gap:8px; margin:4px 0; }
  .floater .item input[type="text"]{
    flex:1; padding:6px 8px; border:1px solid var(--stroke); border-radius:6px; font-size:14px;
  }
  .floater .item input[type="checkbox"]{
    accent-color:#d22; /* checkbox turns name red when checked via class */
  }
  .floater .item.assigned input[type="text"]{ background: var(--shade); }

  .todo .item { margin:4px 0; }
  .todo .item input[type="text"]{
    width:100%; padding:6px 8px; border:1px solid var(--stroke); border-radius:6px; font-size:14px;
  }

  /* Small calendar popover */
  dialog#calendar { padding:0; border:1px solid var(--stroke); border-radius:8px; }
  dialog#calendar .calwrap { padding:8px; min-width: 260px; }
  dialog#calendar header { display:flex; justify-content:space-between; align-items:center; padding:8px; }
  dialog#calendar table { width:100%; border-collapse:collapse; }
  dialog#calendar th, dialog#calendar td { text-align:center; padding:6px; }
  dialog#calendar td button { border:none; background:#f0f0f0; border-radius:6px; padding:6px 0; width:100%; }
</style>
</head>
<body>

<header>
  <h1>HVAC Weekly Schedule</h1>
  <div class="toolbar">
    <button class="btn cal-btn" id="openCal" aria-label="Open calendar">ðŸ“…</button>
    <button class="btn" id="prevWeek">Previous Week</button>
    <button class="btn" id="todayBtn">Today</button>
    <button class="btn" id="nextWeek">Next Week</button>
    <button class="btn" id="resetWeek">Reset Week</button>
    <button class="btn" onclick="window.print()">Print</button>
  </div>
</header>

<div class="wrap">
  <div id="grid" class="grid" aria-live="polite"></div>
</div>

<!-- Bottom sections (stay aligned to grid width) -->
<div class="bottom">
  <section class="floater">
    <h3>Floaters</h3>
    <div id="floaterList"></div>
  </section>
  <section class="todo">
    <h3>Need to be done jobs</h3>
    <div id="todoList"></div>
  </section>
</div>

<div id="log" class="log" aria-label="Debug log"></div>

<!-- Simple Month Picker -->
<dialog id="calendar"><div class="calwrap">
  <header>
    <button class="btn" id="calPrev">â—€</button>
    <div id="calTitle" style="font-weight:600"></div>
    <button class="btn" id="calNext">â–¶</button>
  </header>
  <table>
    <thead><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr></thead>
    <tbody id="calBody"></tbody>
  </table>
  <div style="padding:8px; text-align:right;">
    <button class="btn" id="calClose">Close</button>
  </div>
</div></dialog>

<script>
/* ------------------ UTIL ------------------ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const log = (...args) => {
  const line = '[' + new Date().toLocaleTimeString() + '] ' + args.map(a => {
    try { return typeof a === 'string' ? a : JSON.stringify(a); } catch(e){ return String(a); }
  }).join(' ');
  const el = document.getElementById('log');
  el.textContent += line + '\n';
  el.scrollTop = el.scrollHeight;
};

const isoWeekKey = (d=new Date())=>{
  // key like 2025-W34 (Mon-based)
  const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = dt.getUTCDay() || 7;
  dt.setUTCDate(dt.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((dt - yearStart) / 86400000) + 1) / 7);
  return dt.getUTCFullYear() + '-W' + String(weekNo).padStart(2,'0');
};

const startOfWeek = (d=new Date())=>{
  const x = new Date(d);
  const day = x.getDay(); // 0 Sun .. 6 Sat
  const diff = (day === 0 ? -6 : 1) - day; // Monday start
  x.setDate(x.getDate() + diff);
  x.setHours(0,0,0,0);
  return x;
};

const fmt = (d)=> d.toLocaleDateString(undefined,{weekday:'short', month:'numeric', day:'numeric'});

/* ------------------ STATE ------------------ */
let currentMonday = startOfWeek(new Date());
const CREW_COUNT = 12;
const DAYS = 5; // Mon-Fri

// in-memory model (kept simple)
let state = {
  crews: Array.from({length: CREW_COUNT}, ()=>({lead:'', apprentice:''})),
  cells: {} // key: row-day -> {job:'', helper:'', leadPTO:false, helperPTO:false}
};

// persistent lists
let persistent = {
  floaters: Array.from({length:10}, ()=>({name:'', assigned:false})),
  todos: Array.from({length:12}, ()=>({text:''}))
};

/* ------------------ SAVE / LOAD (de-bounced) ------------------ */
let saveTimer = null;
const queueSave = (what) => {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> doSave(what), 600); // batch edits within 600ms
};

async function doSave(what){
  const payload = {
    weekKey: isoWeekKey(currentMonday),
    state, persistent, what
  };
  log('save', {key: payload.weekKey, what});
  try{
    // Adjust to your Netlify function names if different
    await fetch('/.netlify/functions/save-week', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
  }catch(e){
    log('save-error', String(e));
  }
}

async function loadAll(){
  const key = isoWeekKey(currentMonday);
  try{
    const r1 = await fetch('/.netlify/functions/load-week?key='+encodeURIComponent(key));
    if (r1.ok){
      const json = await r1.json();
      if (json && json.state){ state = json.state; }
      log('load-week', {status:r1.status, ok:r1.ok, key});
    } else {
      log('load-week', {status:r1.status, ok:false, key});
    }
  }catch(e){ log('load-week-error', String(e)); }

  try{
    const r2 = await fetch('/.netlify/functions/load-persistent');
    if (r2.ok){
      const json = await r2.json();
      if (json && json.persistent){ persistent = json.persistent; }
      log('load-persistent', {status:r2.status, ok:r2.ok});
    } else {
      log('load-persistent', {status:r2.status, ok:false});
    }
  }catch(e){ log('load-persistent-error', String(e)); }
}

/* ------------------ RENDER ------------------ */
function createGrid(){
  const grid = $('#grid');
  grid.innerHTML = '';

  // Header row
  const headLeft = document.createElement('div');
  headLeft.className = 'th small';
  headLeft.textContent = 'Crew Lead';
  grid.appendChild(headLeft);

  for(let d=0; d<DAYS; d++){
    const th = document.createElement('div');
    th.className='th';
    const dayDate = new Date(currentMonday); dayDate.setDate(dayDate.getDate()+d);
    th.textContent = fmt(dayDate);
    grid.appendChild(th);
  }

  // Rows
  for(let r=0; r<CREW_COUNT; r++){
    // Crew column
    const crew = document.createElement('div');
    crew.className = 'crewcell';
    const lead = document.createElement('input');
    lead.type = 'text'; lead.placeholder = 'Crew Lead'; lead.value = state.crews[r]?.lead || '';
    lead.dataset.role = 'lead'; lead.dataset.row = r;
    const appr = document.createElement('input');
    appr.type = 'text'; appr.placeholder = 'Apprentice'; appr.value = state.crews[r]?.apprentice || '';
    appr.dataset.role = 'apprentice'; appr.dataset.row = r;
    crew.append(lead, appr);
    grid.appendChild(crew);

    // Day cells
    for(let d=0; d<DAYS; d++){
      const key = `${r}-${d}`;
      const data = state.cells[key] || (state.cells[key] = {job:'', helper:'', leadPTO:false, helperPTO:false});

      const cell = document.createElement('div');
      cell.className = 'cell';

      const bubble = document.createElement('div');
      bubble.className = 'bubble' + (data.leadPTO ? ' lead-out' : '');

      const ptos = document.createElement('div');
      ptos.className = 'ptos';

      // Lead PTO (shades bubble)
      const labLead = document.createElement('label');
      labLead.title = 'Lead PTO';
      const c1 = document.createElement('input');
      c1.type='checkbox'; c1.checked = !!data.leadPTO; c1.dataset.pto='lead'; c1.dataset.key = key;
      labLead.append(c1, document.createTextNode('L'));
      ptos.appendChild(labLead);

      // Helper PTO (red check only, no shading)
      const labHelp = document.createElement('label');
      labHelp.title = 'Helper PTO';
      const c2 = document.createElement('input');
      c2.type='checkbox'; c2.className='helper-pto'; c2.checked = !!data.helperPTO; c2.dataset.pto='helper'; c2.dataset.key = key;
      labHelp.append(c2, document.createTextNode('H'));
      ptos.appendChild(labHelp);

      const job = document.createElement('textarea');
      job.className='job';
      job.placeholder = (d===0) ? 'Job' : '';
      job.value = data.job || '';
      job.dataset.key = key; job.dataset.field='job';

      const helper = document.createElement('input');
      helper.type='text'; helper.className='helper';
      helper.placeholder = (d===0) ? 'Helper' : '';
      helper.value = data.helper || '';
      helper.dataset.key = key; helper.dataset.field='helper';

      bubble.append(ptos, job, helper);
      cell.appendChild(bubble);
      grid.appendChild(cell);
    }
  }
}

/* ------------------ EVENT DELEGATION (no duplicate listeners) ------------------ */
function attachHandlers(){
  // Crew name/apprentice
  $('#grid').addEventListener('input', (e)=>{
    const t = e.target;
    if (t.matches('.crewcell input[type="text"]')){
      const row = +t.dataset.row;
      if (t.dataset.role==='lead') state.crews[row].lead = t.value;
      else state.crews[row].apprentice = t.value;
      log('crew-change', {row, role:t.dataset.role, val:t.value});
      queueSave('crew');
    }
  }, {passive:true});

  // Job / Helper edits (debounced)
  $('#grid').addEventListener('input', (e)=>{
    const t = e.target;
    if (t.dataset && t.dataset.key){
      const cell = state.cells[t.dataset.key];
      cell[t.dataset.field] = t.value;
      log('edit', {key:t.dataset.key, field:t.dataset.field, val:t.value});
      queueSave('cell');
    }
  }, {passive:true});

  // PTO toggles
  $('#grid').addEventListener('change', (e)=>{
    const t = e.target;
    if (t.type==='checkbox' && t.dataset && t.dataset.key){
      const cell = state.cells[t.dataset.key];
      if (t.dataset.pto==='lead'){
        cell.leadPTO = t.checked;
        // apply shading on the bubble only for LEAD
        const bubble = t.closest('.bubble');
        if (bubble){
          bubble.classList.toggle('lead-out', t.checked);
        }
      }else{
        cell.helperPTO = t.checked; // no shading change
      }
      log('pto', {key:t.dataset.key, who:t.dataset.pto, checked:t.checked});
      queueSave('pto');
    }
  });

  // Navigation
  $('#prevWeek').onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()-7); refreshWeek(); };
  $('#nextWeek').onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()+7); refreshWeek(); };
  $('#todayBtn').onclick = ()=>{ currentMonday = startOfWeek(new Date()); refreshWeek(); };
  $('#resetWeek').onclick = ()=>{ state.cells = {}; createGrid(); };

  // Calendar dialog
  const cal = $('#calendar');
  $('#openCal').onclick = ()=>{ buildCalendar(currentMonday); cal.showModal(); };
  $('#calClose').onclick = ()=> cal.close();
  $('#calPrev').onclick = ()=>{ calMonthOffset(-1); };
  $('#calNext').onclick = ()=>{ calMonthOffset(1); };
}

async function refreshWeek(){
  await loadAll();
  createGrid();
}

/* ------------------ CALENDAR ------------------ */
let calCursor = new Date();
function buildCalendar(anchor){
  calCursor = new Date(anchor.getFullYear(), anchor.getMonth(), 1);
  renderCalendar();
}
function calMonthOffset(n){
  calCursor.setMonth(calCursor.getMonth()+n);
  renderCalendar();
}
function renderCalendar(){
  $('#calTitle').textContent = calCursor.toLocaleDateString(undefined,{month:'long', year:'numeric'});
  const first = new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
  const start = new Date(first); start.setDate(1 - (first.getDay())); // start Sunday grid
  const body = $('#calBody'); body.innerHTML='';
  let d = new Date(start);
  for(let r=0;r<6;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<7;c++){
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.textContent = d.getDate();
      if (d.getMonth()!==calCursor.getMonth()) btn.style.opacity = .35;
      btn.onclick = ()=>{
        currentMonday = startOfWeek(d);
        $('#calendar').close();
        refreshWeek();
      };
      td.appendChild(btn); tr.appendChild(td); d.setDate(d.getDate()+1);
    }
    body.appendChild(tr);
  }
}

/* ------------------ BOTTOM SECTIONS ------------------ */
function renderBottom(){
  // Floaters
  const fl = $('#floaterList'); fl.innerHTML='';
  persistent.floaters.forEach((f, i)=>{
    const row = document.createElement('div'); row.className='item' + (f.assigned?' assigned':'');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!f.assigned;
    const name = document.createElement('input'); name.type='text'; name.placeholder='Name'; name.value=f.name||'';
    cb.onchange = ()=>{ f.assigned = cb.checked; row.classList.toggle('assigned', cb.checked); queueSave('floaters'); };
    name.oninput = ()=>{ f.name = name.value; log('floater-name', {i, val:name.value}); queueSave('floaters'); };
    row.append(cb, name); fl.appendChild(row);
  });

  // To-do jobs
  const tl = $('#todoList'); tl.innerHTML='';
  persistent.todos.forEach((t, i)=>{
    const row = document.createElement('div'); row.className='item';
    const inp = document.createElement('input'); inp.type='text'; inp.placeholder='Job';
    inp.value = t.text || '';
    inp.oninput = ()=>{ t.text = inp.value; log('todo', {i, val:inp.value}); queueSave('todos'); };
    row.appendChild(inp); tl.appendChild(row);
  });
}

/* ------------------ INIT ------------------ */
(async function init(){
  await loadAll();
  createGrid();
  renderBottom();
  attachHandlers();
})();
</script>
</body>
</html>
