<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HVAC Weekly Schedule</title>
<style>
  :root{
    --page-max: 1360px;
    --left-col: 190px;

    /* Row + input sizes */
    --cell-min-h: 74px;
    --name-h: 30px;
    --helper-h: 30px;

    /* exact 2-line job geometry (works on iPad Safari) */
    --job-line: 20px;              /* px line-height */
    --job-vpad: 6px;               /* top/bottom padding */
    --job-hpad: 8px;               /* left/right padding */
    --job-height: calc(2*var(--job-line) + 2*var(--job-vpad)); /* 2 visible lines */

    /* Colors */
    --grid-border:#cfcfcf;
    --hdr-bg:#f5f5f5;
    --shade: rgba(255,0,0,0.10);
    --blue:#0a84ff;   /* helper PTO + helper text */
    --red:#c00;       /* crew PTO */
  }

  html,body{background:#fff}
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;margin:0}
  .wrap{max-width:var(--page-max);margin:16px auto 28px;padding:0 12px}
  h1{margin:6px 0 8px;text-align:center;font-size:22px;font-weight:700}

  /* toolbar */
  .toolbar{display:flex;justify-content:center;align-items:center;gap:8px;margin:8px 0 12px}
  .btn{font-size:14px;padding:6px 10px;border:1px solid #bbb;background:#fff;border-radius:6px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .calendar-btn{padding:4px 8px;font-size:18px}

  /* week header */
  .weekbar{display:grid;grid-template-columns:var(--left-col) repeat(5,1fr);border:1px solid var(--grid-border);border-bottom:0;background:var(--hdr-bg)}
  .weekbar>div{height:30px;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--grid-border);font-size:14px;padding:0 6px}
  .weekbar>div:last-child{border-right:0}
  .crew-lead-head{font-weight:600}

  /* grid */
  .grid{display:grid;grid-template-columns:var(--left-col) repeat(5,1fr);border:1px solid var(--grid-border)}
  .leadcell,.cell{border-right:1px solid var(--grid-border);border-top:1px solid var(--grid-border);background:#fff;min-height:var(--cell-min-h)}
  .grid>:nth-child(-n+6){border-top:0}
  .grid>:nth-child(6n){border-right:0}

  /* left column */
  .leadcell{padding:6px;display:flex;flex-direction:column;gap:6px}
  .lead-input,.apprentice-input{
    width:100%;height:var(--name-h);
    border:1px solid #bbb;border-radius:4px;padding:6px 8px;font-size:14px;line-height:18px;background:#fff;box-sizing:border-box
  }

  /* ===== Day cell: 2-column layout ===== */
  .cell{padding:0;overflow:hidden}
  .cell-inner{
    display:grid; grid-template-columns: 1fr 24px; /* ‚Üê 24px PTO rail */
    column-gap:6px; height:100%; padding:6px; box-sizing:border-box; position:relative
  }
  .cell-main{display:flex;flex-direction:column;gap:4px}
  .cell-pto{display:flex;flex-direction:column;justify-content:space-between;align-items:center;padding:2px 0}

  /* inputs */
  .job{
    width:100%; height:var(--job-height);
    border:1px solid #bbb;border-radius:4px;
    padding:var(--job-vpad) var(--job-hpad); box-sizing:border-box;
    font-size:14px; line-height:var(--job-line); resize:none; background:#fff
  }
  .job:focus{outline:2px solid rgba(0,0,0,0.08)}
  .helper{
    width:100%; height:var(--helper-h);
    border:1px solid #bbb;border-radius:4px;
    padding:4px 8px; box-sizing:border-box;
    font-size:14px; background:#fff; color:var(--blue)
  }
  .helper::placeholder{opacity:.7;color:#7a7a7a}

  /* PTO checkboxes (native, colored) */
  .cell-pto input{width:16px;height:16px}
  .cell-pto .helper-pto{accent-color:var(--blue)} /* top */
  .cell-pto .crew-pto{accent-color:var(--red)}   /* bottom */

  /* Helper-PTO shading */
  .shade{background:var(--shade)}

  /* bottom: Floaters left / To‚Äëdos right */
  .bottom-wrap{display:flex;gap:12px;align-items:flex-start;margin-top:12px}
  .floaters{flex:1;border:1px solid var(--grid-border);border-radius:6px;padding:10px;background:#fff}
  .todo{flex:3;border:1px solid var(--grid-border);border-radius:6px;padding:10px;background:#fff}
  .section-title{font-weight:600;margin-bottom:6px}
  .todo-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .todo-grid input{width:100%;border:1px solid #bbb;border-radius:4px;padding:6px 8px;font-size:14px;background:#fff}
  .floater-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .floater-row input[type="text"]{flex:1;border:1px solid #bbb;border-radius:4px;padding:6px 8px;font-size:14px;background:#fff}
  .floater-row input[type="checkbox"]{width:16px;height:16px;accent-color:var(--red)}
  .floater-assigned{background:var(--shade);border-radius:4px;padding:2px}

  /* log + modal (unchanged) */
  .log{margin-top:12px;border:1px solid var(--grid-border);border-radius:6px;overflow:hidden;background:#fff}
  .log h3{margin:0;padding:8px 10px;background:var(--hdr-bg);font-size:14px}
  .logpre{margin:0;padding:8px 10px;height:140px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#fff}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;align-items:center;justify-content:center}
  .modal{background:#fff;padding:12px;border-radius:10px;width:300px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
  .modal h4{margin:0 0 8px}
  .modal input[type="date"]{width:100%;padding:8px;font-size:16px}
</style>
</head>
<body>
<div class="wrap">
  <h1>HVAC Weekly Schedule</h1>

  <div class="toolbar">
    <button class="btn calendar-btn" id="openCalendar" title="Pick a date">üìÖ</button>
    <button class="btn" id="prevWeek">Previous Week</button>
    <button class="btn" id="todayBtn">Today</button>
    <button class="btn" id="nextWeek">Next Week</button>
    <button class="btn" id="resetWeek">Reset Week</button>
    <button class="btn" id="printBtn">Print</button>
  </div>

  <div class="weekbar">
    <div class="crew-lead-head">Crew Lead</div>
    <div id="d0"></div><div id="d1"></div><div id="d2"></div><div id="d3"></div><div id="d4"></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="bottom-wrap">
    <div class="floaters">
      <div class="section-title">Floaters (10)</div>
      <div id="floatersList"></div>
    </div>
    <div class="todo">
      <div class="section-title">Need to be done jobs (12)</div>
      <div class="todo-grid" id="todoGrid"></div>
    </div>
  </div>

  <div class="log">
    <h3>Log</h3>
    <pre class="logpre" id="log"></pre>
  </div>
</div>

<!-- Calendar modal -->
<div class="modal-backdrop" id="calBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h4>Jump to week</h4>
    <input type="date" id="datePicker"/>
  </div>
</div>

<script>
(() => {
  const CREWS=12, DAYS=5;
  const STORAGE_MODE='local';
  const API_BASE='/.netlify/functions';
  const LOG=(tag,p)=>{const L=document.getElementById('log');if(!L)return;const t=new Date().toLocaleTimeString();L.textContent+=`[${t}] ${tag} ${p?JSON.stringify(p):""}\n`;L.scrollTop=L.scrollHeight};

  let currentMonday=getMonday(new Date());
  let weekData=blankWeek();
  let persistent=blankPersistent();
  let savingWeek=false,savingPersistent=false;

  function getMonday(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=x.getDay();x.setDate(x.getDate()+(day===0?-6:1-day));x.setHours(0,0,0,0);return x}
  function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
  function fmtDay(date){return `${date.toLocaleDateString(undefined,{weekday:'short'})} ${(date.getMonth()+1)}/${date.getDate()}`}
  function weekKey(d){
    const date=new Date(d);date.setHours(0,0,0,0);
    const jan4=new Date(date.getFullYear(),0,4);
    const w1=getMonday(jan4), mon=getMonday(date);
    const num=1+Math.round((mon-w1)/(7*24*3600*1000));
    return `${date.getFullYear()}-W${String(num).padStart(2,'0')}`;
  }
  function blankWeek(){const jobs=[],helpers=[],cpto=[],hpto=[];for(let r=0;r<CREWS;r++){jobs[r]=Array(DAYS).fill("");helpers[r]=Array(DAYS).fill("");cpto[r]=Array(DAYS).fill(false);hpto[r]=Array(DAYS).fill(false)}return{jobs,helpers,crewPTO:cpto,helperPTO:hpto}}
  function blankPersistent(){return{crewLeads:Array(CREWS).fill(""),apprentices:Array(CREWS).fill(""),floaters:Array(10).fill(""),todos:Array(12).fill("")}}
  const debounce=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  function renderHeader(){for(let c=0;c<DAYS;c++){document.getElementById('d'+c).textContent=fmtDay(addDays(currentMonday,c))}}

  function makeCell(r,c){
    const cell=document.createElement('div'); cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c;

    const inner=document.createElement('div'); inner.className='cell-inner';
    const main=document.createElement('div'); main.className='cell-main';
    const rail=document.createElement('div'); rail.className='cell-pto';

    const job=document.createElement('textarea');
    job.className='job'; job.placeholder=(c===0?'Job':''); job.value=weekData.jobs[r][c]||"";
    job.addEventListener('input', (e)=>{weekData.jobs[r][c]=e.target.value; LOG('job',{r,c,val:e.target.value}); saveWeekDeb();});

    const helper=document.createElement('input');
    helper.className='helper'; helper.placeholder=(c===0?'Helper':''); helper.value=weekData.helpers[r][c]||"";
    helper.addEventListener('input',(e)=>{weekData.helpers[r][c]=e.target.value; LOG('helper',{r,c,val:e.target.value}); saveWeekDeb();});

    /* PTOs in the dedicated rail (no overlap) */
    const hcb=document.createElement('input'); hcb.type='checkbox'; hcb.className='helper-pto'; hcb.checked=!!weekData.helperPTO[r][c];
    hcb.addEventListener('change',(e)=>{weekData.helperPTO[r][c]=e.target.checked; cell.classList.toggle('shade',e.target.checked); LOG('pto-helper',{r,c,checked:e.target.checked}); saveWeekDeb();});
    const ccb=document.createElement('input'); ccb.type='checkbox'; ccb.className='crew-pto'; ccb.checked=!!weekData.crewPTO[r][c];
    ccb.addEventListener('change',(e)=>{weekData.crewPTO[r][c]=e.target.checked; LOG('pto-crew',{r,c,checked:e.target.checked}); saveWeekDeb();});

    /* Build */
    main.appendChild(job);
    main.appendChild(helper);
    rail.appendChild(hcb);       /* top (blue) */
    rail.appendChild(ccb);       /* bottom (red) */
    inner.appendChild(main);
    inner.appendChild(rail);
    cell.appendChild(inner);
    return cell;
  }

  function renderGrid(){
    const g=document.getElementById('grid'); g.innerHTML="";
    for(let r=0;r<CREWS;r++){
      const lead=document.createElement('div'); lead.className='leadcell';
      const leadIn=document.createElement('input'); leadIn.className='lead-input'; leadIn.placeholder='Crew Lead'; leadIn.value=persistent.crewLeads[r]||"";
      leadIn.dataset.r=r; leadIn.addEventListener('input',(e)=>{persistent.crewLeads[r]=e.target.value; LOG('crew-lead',{r,val:e.target.value}); savePersistentDeb();});
      const appr=document.createElement('input'); appr.className='apprentice-input'; appr.placeholder='Apprentice'; appr.value=persistent.apprentices[r]||"";
      appr.dataset.r=r; appr.addEventListener('input',(e)=>{persistent.apprentices[r]=e.target.value; LOG('apprentice',{r,val:e.target.value}); savePersistentDeb();});
      lead.appendChild(leadIn); lead.appendChild(appr);
      g.appendChild(lead);

      for(let c=0;c<DAYS;c++){ g.appendChild(makeCell(r,c)); }
    }
  }

  function renderBottom(){
    const fl=document.getElementById('floatersList'); fl.innerHTML="";
    for(let i=0;i<persistent.floaters.length;i++){
      const row=document.createElement('div'); row.className='floater-row';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.addEventListener('change',()=>row.classList.toggle('floater-assigned',cb.checked));
      const t=document.createElement('input'); t.type='text'; t.placeholder=`Floater ${i+1}`; t.value=persistent.floaters[i]||"";
      t.dataset.i=i; t.addEventListener('input',(e)=>{persistent.floaters[i]=e.target.value; LOG('floater',{i,val:e.target.value}); savePersistentDeb();});
      row.appendChild(cb); row.appendChild(t); fl.appendChild(row);
    }
    const tg=document.getElementById('todoGrid'); tg.innerHTML="";
    for(let i=0;i<persistent.todos.length;i++){
      const t=document.createElement('input'); t.type='text'; t.placeholder=`Job ${i+1}`; t.value=persistent.todos[i]||"";
      t.dataset.i=i; t.addEventListener('input',(e)=>{persistent.todos[i]=e.target.value; LOG('todo',{i,val:e.target.value}); savePersistentDeb();});
      tg.appendChild(t);
    }
  }

  const saveWeekDeb=debounce(saveWeek,200);
  const savePersistentDeb=debounce(savePersistent,200);

  function lsWeekKey(){return `wk:${weekKey(currentMonday)}`}
  const LS_PERSIST='persist:v1';

  async function loadWeek(){
    if(STORAGE_MODE==='local'){
      const raw=localStorage.getItem(lsWeekKey()); LOG('load-week-local',{key:lsWeekKey(),found:!!raw});
      weekData = raw? JSON.parse(raw) : blankWeek();
    }else{
      try{
        const res=await fetch(`${API_BASE}/load-week`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:weekKey(currentMonday)})});
        const data=await res.json().catch(()=>({}));
        LOG('load-week',{status:res.status,ok:res.ok});
        weekData = (res.ok && data && data.week)? data.week : blankWeek();
      }catch(err){LOG('load-week-error',{err:String(err)});weekData=blankWeek()}
    }
  }
  async function saveWeek(){
    if(savingWeek) return; savingWeek=true;
    const key=weekKey(currentMonday);
    if(STORAGE_MODE==='local'){
      localStorage.setItem(lsWeekKey(),JSON.stringify(weekData));
      LOG('save-week-local',{key});
    }else{
      try{
        const res=await fetch(`${API_BASE}/save-week`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key,week:weekData})});
        LOG('save-week',{status:res.status,ok:res.ok});
      }catch(err){LOG('save-week-error',{err:String(err)})}
    }
    savingWeek=false;
  }
  async function loadPersistent(){
    if(STORAGE_MODE==='local'){
      const raw=localStorage.getItem(LS_PERSIST); LOG('load-persistent-local',{found:!!raw});
      persistent = raw ? Object.assign(blankPersistent(), JSON.parse(raw)) : blankPersistent();
    }else{
      try{
        const res=await fetch(`${API_BASE}/load-persistent`,{method:'POST',headers:{'Content-Type':'application/json'}});
        const data=await res.json().catch(()=>({}));
        LOG('load-persistent',{status:res.status,ok:res.ok});
        if(res.ok && data && data.persistent){
          persistent = Object.assign(blankPersistent(), data.persistent);
        }
      }catch(err){LOG('load-persistent-error',{err:String(err)})}
    }
  }
  async function savePersistent(){
    if(savingPersistent) return; savingPersistent=true;
    if(STORAGE_MODE==='local'){
      localStorage.setItem(LS_PERSIST,JSON.stringify(persistent));
      LOG('save-persistent-local',{ok:true});
    }else{
      try{
        const res=await fetch(`${API_BASE}/save-persistent`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({persistent})});
        LOG('save-persistent',{status:res.status,ok:res.ok});
      }catch(err){LOG('save-persistent-error',{err:String(err)})}
    }
    savingPersistent=false;
  }

  function goToMonday(d){
    currentMonday=getMonday(d);
    renderHeader();
    weekData=blankWeek();
    renderGrid();
    loadWeek().then(()=>renderGrid());
    document.dispatchEvent(new CustomEvent('weekchange',{detail:{monday:currentMonday}}));
  }

  const $=id=>document.getElementById(id);
  $('prevWeek').addEventListener('click',()=>goToMonday(addDays(currentMonday,-7)));
  $('nextWeek').addEventListener('click',()=>goToMonday(addDays(currentMonday, 7)));
  $('todayBtn').addEventListener('click',()=>goToMonday(new Date()));
  $('resetWeek').addEventListener('click',()=>{weekData=blankWeek();renderGrid();saveWeek();LOG('reset-week',{key:weekKey(currentMonday)})});
  $('printBtn').addEventListener('click',()=>window.print());

  const backdrop=$('calBackdrop'), datePicker=$('datePicker');
  $('openCalendar').addEventListener('click',()=>{
    backdrop.style.display='flex';
    const iso=new Date(currentMonday.getTime()-currentMonday.getTimezoneOffset()*60000).toISOString().slice(0,10);
    datePicker.value=iso; datePicker.focus();
  });
  backdrop.addEventListener('click',(e)=>{ if(e.target===backdrop) backdrop.style.display='none'; });
  datePicker.addEventListener('change',()=>{
    const v=datePicker.value; if(v){ goToMonday(new Date(v+"T12:00:00")); }
    backdrop.style.display='none';
  });

  window.addEventListener('DOMContentLoaded', async ()=>{
    renderHeader(); renderGrid(); renderBottom();
    await loadPersistent(); await loadWeek();
    renderGrid(); renderBottom();
    LOG('ready',{mode:STORAGE_MODE,week:weekKey(currentMonday)});
  });
})();
</script>
</body>
</html>
